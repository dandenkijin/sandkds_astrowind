---
// src/pages/admin.astro
// This is a client-side only page for Decap CMS
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    
    <!-- CSP Meta Tag - Simplified for meta tag compatibility -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' 
        https://identity.netlify.com 
        https://cdn.jsdelivr.net;
      style-src 'self' 'unsafe-inline' 
        https://cdn.jsdelivr.net;
      img-src 'self' data: https:;
      font-src 'self' data: https:;
      connect-src 'self' 
        https://api.netlify.com 
        https://api.github.com 
        https://identity.netlify.com;
      form-action 'self';
      base-uri 'self';">
    
    <!-- Preconnect to required domains -->
    <link rel="preconnect" href="https://identity.netlify.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Decap CMS CSS with fallback -->
    <link 
      rel="stylesheet" 
      href="https://cdn.jsdelivr.net/npm/decap-cms@3.8.3/dist/decap-cms.css" 
      crossorigin="anonymous" />
    
    <!-- Fallback styles -->
    <style id="cms-styles">
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }
      #nc-root { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 2rem;
        min-height: 100vh;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      .loading { 
        text-align: center; 
        padding: 4rem 2rem;
        color: #333;
      }
      .error { 
        color: #dc2626; 
        background: #fef2f2; 
        padding: 1.5rem; 
        border-radius: 0.5rem; 
        margin: 1rem 0;
        border-left: 4px solid #dc2626;
      }
      button {
        background: #3182ce;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
      }
      button:hover {
        background: #2c5282;
      }
    </style>
  </head>
  <body>
    <div id="nc-root">
      <div class="loading">
        <h1>Loading Decap CMS...</h1>
        <p>Please wait while we load the content management system.</p>
      </div>
    </div>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script>
    
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.js" defer></script>
    
    <!-- Decap CMS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.css" />
    
    <!-- Initialize CMS -->
    <script>
      // Show loading state
      const root = document.getElementById('nc-root');
      
      function showError(message) {
        console.error('CMS Error:', message);
        if (!root) return;
        
        root.innerHTML = `
          <div class="error">
            <h2>Error Loading CMS</h2>
            <p>${message}</p>
            <p>Common issues:</p>
            <ul>
              <li>Check your internet connection</li>
              <li>Try disabling any ad blockers for this site</li>
              <li>Check the browser console (F12) for detailed errors</li>
            </ul>
            <button onclick="window.location.reload()">Reload Page</button>
          </div>
        `;
      }

      // Check if CMS loaded
      if (typeof CMS === 'undefined') {
        showError('Failed to load Decap CMS. Please check your internet connection and try again.');
      } else {
        initializeCMS();
      }

      function initializeCMS() {
        console.log('Initializing Decap CMS...');
        
        // Set manual init
        window.CMS_MANUAL_INIT = true;
        
        // Check if CMS is loaded
        if (typeof CMS === 'undefined') {
          console.error('CMS not loaded');
          return;
        }

        try {
          // Define config directly in JavaScript
          const config = {
            backend: {
              name: 'git-gateway',
              branch: 'main'
            },
            local_backend: true,
            media_folder: 'public/images/uploads',
            public_folder: '/images/uploads',
            site_url: window.location.origin,
            display_url: window.location.origin,
            logo_url: 'https://decapcms.org/img/decap-logo.svg',
            collections: [
              {
                name: 'pages',
                label: 'Pages',
                files: [
                  {
                    label: 'Home',
                    name: 'home',
                    file: 'src/content/pages/home.md',
                    fields: [
                      { label: 'Title', name: 'title', widget: 'string' },
                      { label: 'Body', name: 'body', widget: 'markdown' },
                      { label: 'Hero Image', name: 'hero_image', widget: 'image' },
                      { label: 'SEO Title', name: 'seo_title', widget: 'string', required: false },
                      { label: 'SEO Description', name: 'seo_description', widget: 'text', required: false }
                    ]
                  }
                ]
              },
              {
                name: 'blog',
                label: 'Blog',
                folder: 'src/content/blog',
                create: true,
                slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
                fields: [
                  { label: 'Title', name: 'title', widget: 'string' },
                  { label: 'Publish Date', name: 'date', widget: 'datetime' },
                  { label: 'Author', name: 'author', widget: 'string' },
                  { label: 'Featured Image', name: 'image', widget: 'image', required: false },
                  { label: 'Excerpt', name: 'excerpt', widget: 'text' },
                  { label: 'Body', name: 'body', widget: 'markdown' },
                  { label: 'Tags', name: 'tags', widget: 'list', required: false }
                ]
              }
            ]
          };
          
          // Initialize CMS with the config
          CMS.init({ config });

          // Handle Netlify Identity
          if (window.netlifyIdentity) {
            console.log('Netlify Identity found, initializing...');
            window.netlifyIdentity.on('init', function(user) {
              console.log('Netlify Identity initialized', user ? 'User logged in' : 'No user');
              if (!user) {
                window.netlifyIdentity.on('login', function() {
                  console.log('User logged in, reloading...');
                  document.location.href = '/admin/';
                });
              }
            });
          } else {
            console.warn('Netlify Identity not found');
          }
          
          console.log('Decap CMS initialized successfully');
          
        } catch (error) {
          console.error('Error initializing CMS:', error);
          showError(`CMS Initialization Error: ${error.message}`);
        }
      }
      
      // Global error handler
      window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        showError(`An error occurred: ${event.message}`);
      });
      
      // Handle unhandled promise rejections
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled rejection:', event.reason);
        showError(`An error occurred: ${event.reason?.message || event.reason || 'Unknown error'}`);
      });
    </script>
  </body>
</html>
